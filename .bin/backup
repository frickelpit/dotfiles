#!/bin/bash
#####################################################
## backup-script by Frickelpit using rsync and tar ##
## created for learning some bash skills	   ##
#####################################################

## dirs ##
BUP="/mnt/backup"
BDIR="/mnt/backup/mondkuchen"
SRC="$HOME/"

## files ##
FILE="$HOME/.rsync-backupfile"
LOG="$HOME/.backup.log"

## vars ##
DTE=`date +%F`
PKGH=`grep ">f" $LOG | wc -l`

if [ ! -d $BDIR ]; then
  notify-send "Abbruch" "Zielverzeichnis nicht gefunden"
  exit;
  elif ps aux | grep [f]irefox &>/dev/null; then
  notify-send "Abbruch" "Bitte zuerst Firefox schlieÃŸen"
  exit;
  elif [ ! -f $FILE ]; then
  notify-send "Abbruch" "Bitte $FILE anlegen"
  exit;
fi

notify-send "Backup von $SRC wird gestartet"
rm $LOG
if [ -f $BDIR/paclist.txt ]; then
  mv $BDIR/paclist.txt $BDIR/paclist.$DTE.txt
fi
pacman -Qeq > $BDIR/paclist.txt
for f in ~/.mozilla/firefox//.sqlite; do sqlite3 $f 'VACUUM;'; done
rsync -avz --exclude-from=$FILE --log-file=$LOG $SRC $BDIR

## checking if backup succeeded ##
if [ $? -ne 0 ]; then
  notify-send "Warnung!" "Daten konnten nicht gesichert werden!"
else
  notify-send "Sicherung abgeschlossen" "$PKGH Datei(en) gesichert"
fi

## creating a tar.gz ##
tar czf $BUP/backup.$DTE.tar.gz $BDIR &>> $LOG
if [ $? -eq 0 ]; then
  notify-send "Archiv erfolgreich angelegt"
else
  notify-send "Fehler" "Konnte Archiv unter $BUP nicht anlegen"
fi
