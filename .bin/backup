#!/bin/bash
# Backup-Script mit rsync

## Einstellungen ##
BDIR="/mnt/backup/miniluna"
SRC="$HOME/"
FILE="$HOME/.rsync-backupfile"
LOG="$HOME/.backup.log"
PKGH=`grep ">f" $LOG | wc -l`

if [ ! -d $BDIR ];then
  notify-send "Abbruch" "Zielverzeichnis nicht gefunden"
  exit;
  elif ps aux | grep [f]irefox &>/dev/null;then
  notify-send "Achtung" "Bitte zuerst Firefox schlie√üen"
  exit;
  elif [ ! -f $FILE ];then
  notify-send "Abbruch" "Bitte $FILE anlegen"
  exit;
fi

## Das Backup ##
notify-send "Backup von $SRC wird gestartet"
if [ -f $LOG ];then
  rm $LOG
fi
sleep 3
for f in ~/.mozilla/firefox//.sqlite; do sqlite3 $f 'VACUUM;'; done
rsync -avz --exclude-from=$FILE --log-file=$LOG $SRC $BDIR

## Check, ob Backup erfolgreich war ##
if [ $? -ne 0 ];then
  notify-send "Warnung!" "Daten konnten nicht gesichert werden!"
else
  notify-send "Sicherung abgeschlossen" "$PKGH Datei(en) gesichert"
fi
